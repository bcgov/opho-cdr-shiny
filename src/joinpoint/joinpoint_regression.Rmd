---
title: 'DRAFT: BC Chronic Diseases trends: A joinpoint regression analysis'
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: 'Mahmoodur Rahman'
output:
  html_document:
    df_print: paged
    code_folding: hide
bibliography: joinpoint_ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```



```{r libraries}
library(dplyr)
library(readr)
library(segmented)
library(broom)
library(tidyr)
library(modelr)
library(purrr)
```
# Highlevel tasks:

## Background / Methodology / Literature review / Rationale: (Will write rationale of this approach)

List of papers:

 - segmented: an R Package to Fit Regression Models with Broken-Line Relationships. (@muggeo2008segmented)
 - Estimating regression models with unknown break-points. (@muggeo2003estimating)
 - Global increasing incidence of young-onset colorectal cancer across 5 continents: a joinpoint regression analysis of 1,922,167 cases (@lui2019global)
 - Spatial clusters and temporal trends of malignant melanoma mortality in Ecuador. (@nunez2020spatial)
 - Worldwide suicide mortality trends by firearm (1990â€“2019): A joinpoint regression analysis (@ilic2022worldwide)
 
## Data Pre-processing:

### Loading data

```{r Load Data}
CHSA_df <- read_csv("/Users/mahmood/UBCMDS/591_capstone/master_df.csv") |>
  mutate( RATE = as.factor(RATE)) |> 
  mutate( DISEASE = as.factor(DISEASE)) |>
  mutate( HEALTH_BOUNDARIES = as.factor(HEALTH_BOUNDARIES)) |> 
  drop_na()

CHSA_df[CHSA_df == "" | CHSA_df == 0] <- NA
row.has.na <- apply(CHSA_df, 1, function(x){any(is.na(x))})
sum(row.has.na)
CHSA_df <- CHSA_df[!row.has.na,]

```

### Susetting data:

```{r subset}

# Split the data frames according to Rates:

CHSA_data_list <- split(CHSA_df, f = CHSA_df$RATE) 

HSC_CHSA_df <- CHSA_data_list[[1]] |> 
  as.data.frame()|>
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95))

Incidence_CHSA_df <- CHSA_data_list[[2]] |> 
  as.data.frame() |> 
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95))


LifeP_CHSA_df <- CHSA_data_list[[3]] |> 
  as.data.frame() |> 
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95))


```


### Exploratory data analysis

#### Plotting of Rate against Time: 

The following graph plots Age-standardized Incidence Rates of Chronic Diseases in Kimberley CHSA in from 2001 to 2020 (Will label the graph)

```{r eda, fig.width=14, fig.height=12}
# sample data

Incidence_CHSA_df %>%
  filter(HEALTH_BOUNDARIES == "1130 Kimberley") %>%
  ggplot(aes(x=YEAR, y=STD_RATE_PER_1000)) +
  geom_line() +
  facet_wrap(~DISEASE) +
  labs(x = "Years", y = "Age standardized Incidence Rate (per 1000)") +
  ggtitle("Age-standardized Incidence Rates by Diseases in Kimberley")

```

Observations: (Will elaborate later)

 - "Breakpoints" can be seen. Not smooth
 - Each "Piece" is considered a linear relation between Rates and Time (Year)
 
#### Summery sattistics of rates:

```{r rates summary}

summary(HSC_CHSA_df$STD_RATE_PER_1000)
summary(Incidence_CHSA_df$STD_RATE_PER_1000)
summary(LifeP_CHSA_df$STD_RATE_PER_1000)

```
Observations: (Will elaborate later)

 - None of the three rates, namely, HSC Prevalence, Age-Standardized Incidence Rate, and  Age-Standardized Life Prevalence have any negative value

## Building the Model:

### Specifics :

 - Model : Segmented regression (Joinpoint regression)
 - Response (y): Age-Standardized Incidence Rate
 - Predictor : Year
 - `segmented.lm` is used
 - Filtering ALZHEIMER_DEMENTIA and 3213 Fairview CHSA
 
```{r linear regression}

sample_df <- Incidence_CHSA_df %>%
  filter(HEALTH_BOUNDARIES == "3213 Fairview" &
           DISEASE == "ALZHEIMER_DEMENTIA")

lm_model <- lm(STD_RATE_PER_1000~YEAR, data = sample_df)
seg_obj<-segmented(lm_model,seg.Z=~YEAR)

```


### Model daignostics:

#### Regression coefficients:

```{r}
print(summary(seg_obj))
```
Observations: (Will elaborate later)

 - Breakpoint is in Year 2009

#### average annual per cent (AAPC) change:

To summarize piecewise linear relationships in segmented
regression models.
```{r aapc}
print(aapc(seg_obj, wrong.se = FALSE))
```
Observations: (Will elaborate later)

 - Positive aapc refers to an increasing trend

#### Plotting:

```{r}
plot(seg_obj, conf.level=.95, is=TRUE, isV=FALSE, col=1, shade = TRUE, res=TRUE, res.col=1, pch=19)
```

Observations: (Will elaborate later)

 - Epidemiological emphasis: Possible causes can be explored looking at the "Breakpoint" of Year 2009. 


## Fitting the Model: 

```{r}

posslm = possibly(.f = lm, otherwise = NULL)

segment_fit <- function(data){
  model <-  lm(log(STD_RATE_PER_1000)~ YEAR, 
               na.action=na.exclude,
               data=data)
  segmented(model, seg.Z = ~YEAR)
}

# Incidence_CHSA_df %>%
#   ungroup() %>%
#   mutate(segment_fit())
# 
# myData$pred_dist = fitted(model0)


nested_incidence <- Incidence_CHSA_df %>%
  group_by(HEALTH_BOUNDARIES, DISEASE) %>%
  nest()

fitted <- nested_incidence %>% 
  mutate(mod = map(data, segment_fit)) %>% 
  mutate(pred  = map2(data, mod, add_predictions))

```
 









# References
 
 
 
 
 
 
 
 
---
title: 'DRAFT: BC Chronic Diseases trends: A joinpoint regression analysis'
date: "`r format(Sys.time(), '%d %B, %Y')`"
author: 'Mahmoodur Rahman'
output:
  html_document:
    df_print: paged
    code_folding: hide
bibliography: joinpoint_ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

# Calling the libraries:

```{r libraries}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(segmented)
library(broom)
library(tidyr)
library(modelr)
library(purrr)
```

# Background / Methodology / Literature review / Rationale: (Will write rationale of this approach)

List of papers:

 - segmented: an R Package to Fit Regression Models with Broken-Line Relationships. (@muggeo2008segmented)
 - Estimating regression models with unknown break-points. (@muggeo2003estimating)
 - Global increasing incidence of young-onset colorectal cancer across 5 continents: a joinpoint regression analysis of 1,922,167 cases (@lui2019global)
 - Spatial clusters and temporal trends of malignant melanoma mortality in Ecuador. (@nunez2020spatial)
 - Worldwide suicide mortality trends by firearm (1990â€“2019): A joinpoint regression analysis (@ilic2022worldwide)
 
# Data Pre-processing:

## Loading data :

 - Adding a column to represent if the rows have Null, Zero and Missing values

```{r Load Data}
CHSA_df <- read_csv("/Users/mahmood/UBCMDS/591_capstone/master_df.csv") %>%
  mutate( RATE = as.factor(RATE)) %>% 
  mutate( DISEASE = as.factor(DISEASE)) %>%
  mutate( HEALTH_BOUNDARIES = as.factor(HEALTH_BOUNDARIES)) %>%
  mutate(anyTRUE = !if_any(everything(), ~. %in% c(NA,"",0)))

```
## Suseting data:

 - Create three dataframe by three rates:
 
    - HSC Prevalence
    - Age-standardized Incidence Rates
    - Age-Standardized Life Prevalence


```{r subset}
CHSA_data_list <- split(CHSA_df, f = CHSA_df$RATE) 

# incidence data  
Incidence_CHSA_df <- CHSA_data_list[[2]] %>% 
  as.data.frame() %>% 
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95)) %>%
  mutate(anyTRUE = ifelse((
    (DISEASE=='JUVENILE_ARTHRITIS')|
    (HEALTH_BOUNDARIES=='4111 Downtown Victoria/Vic West' & 
             DISEASE=='EPILEPSY')| 
    (HEALTH_BOUNDARIES=='5110 Snow Country' & 
             DISEASE=='HAEMORR_STROKE')|
    (HEALTH_BOUNDARIES=='4114 Oak Bay' & 
             DISEASE=='EPILEPSY')| 
    (HEALTH_BOUNDARIES=='5232 Vanderhoof Rural' & 
             DISEASE=='HAEMORR_STROKE')| 
    (HEALTH_BOUNDARIES=='2334 Panorama' & 
             DISEASE=='HOSP_STROKE')| 
    (HEALTH_BOUNDARIES=='1260 Grand Forks' & 
             DISEASE=='HOSP_TIA')|  
    (HEALTH_BOUNDARIES=='2150 Agassiz/Harrison' & 
             DISEASE=='HOSP_TIA')|  
    (HEALTH_BOUNDARIES=='5222 Burns Lake South' & 
             DISEASE=='HOSP_TIA')| 
    (HEALTH_BOUNDARIES=='1461 West Cariboo' & 
             DISEASE=='PARKINSONISM')| 
    (HEALTH_BOUNDARIES=='2150 Agassiz/Harrison' & 
             DISEASE=='RHEUMATOID_ARTHRITIS')| 
    (HEALTH_BOUNDARIES=='2223 Burnaby Southwest' & 
             DISEASE=='RHEUMATOID_ARTHRITIS')| 
    (HEALTH_BOUNDARIES=='2334 Panorama' & 
             DISEASE=='OSTEOARTHRITIS')| 
    (HEALTH_BOUNDARIES=='5110 Snow Country' & 
             DISEASE=='MS')|
    (HEALTH_BOUNDARIES=='5110 Snow Country' & 
             DISEASE=='PARKINSONISM')|
    (HEALTH_BOUNDARIES=='5110 Snow Country' & 
             DISEASE=='SCHIZOPHRENIA')| 
    (HEALTH_BOUNDARIES=='5222 Burns Lake South' & 
             DISEASE=='PARKINSONISM')|
    (HEALTH_BOUNDARIES=='5232 Vanderhoof Rural' & 
             DISEASE=='PARKINSONISM')|
    (HEALTH_BOUNDARIES== "5322 Hudson's Hope" & 
             DISEASE=='MS')|
    (HEALTH_BOUNDARIES== "5313 Tumbler Ridge" & 
             DISEASE=='PARKINSONISM')|
    (HEALTH_BOUNDARIES== "5331 Fort Nelson Population Centre" & 
             DISEASE=='MS')|
    (HEALTH_BOUNDARIES== "1110 Fernie" & 
             DISEASE=='ALZHEIMER_DEMENTIA')), FALSE, anyTRUE))

# hsc data
HSC_CHSA_df <- CHSA_data_list[[1]] %>% 
  as.data.frame()%>%
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95)) %>%
  mutate(anyTRUE = ifelse(((HEALTH_BOUNDARIES=='1230 Castlegar' & 
             DISEASE=='HOSP_TIA_EPI')|
               (HEALTH_BOUNDARIES=='1390 Enderby' & 
             DISEASE=='SCHIZOPHRENIA_EPI')|
               (HEALTH_BOUNDARIES=='1450 North Thompson' & 
             DISEASE=='HOSP_STROKE_EPI')|
               (HEALTH_BOUNDARIES=='2314 Brookswood/Murrayville' & 
             DISEASE=='HAEMORR_STROKE_EPI')|
               (HEALTH_BOUNDARIES=='5110 Snow Country' & 
             DISEASE=='HAEMORR_STROKE_EPI')|
               (HEALTH_BOUNDARIES=='5232 Vanderhoof Rural' & 
             DISEASE=='HAEMORR_STROKE_EPI')), FALSE, anyTRUE))

  
# Life Prevalence:

LifeP_CHSA_df <- CHSA_data_list[[3]] %>% 
  as.data.frame() %>% 
  dplyr::select(-c(RATE, STD_UCL_95, STD_LCL_95)) %>%  
  mutate(anyTRUE = ifelse((
  (HEALTH_BOUNDARIES=='1461 West Cariboo' & 
             DISEASE=='JUVENILE_ARTHRITIS')| 
  (HEALTH_BOUNDARIES=='5331 Fort Nelson Population Centre' & 
             DISEASE=='JUVENILE_ARTHRITIS')), FALSE, anyTRUE))
  
```



# Exploratory data analysis

## Plotting of Rate against Time on sample dataframe: 

The following graph plots Age-standardized Incidence Rates of Chronic Diseases in Kimberley CHSA in from 2001 to 2020 (Will label the graph)

```{r eda, fig.width=14, fig.height=12}
# sample data

Incidence_CHSA_df %>%
  filter(HEALTH_BOUNDARIES == "1130 Kimberley") %>%
  ggplot(aes(x=YEAR, y=STD_RATE_PER_1000)) +
  geom_line() +
  facet_wrap(~DISEASE) +
  labs(x = "Years", y = "Age standardized Incidence Rate (per 1000)") +
  ggtitle("Age-standardized Incidence Rates by Diseases in Kimberley (2001 to 2020")

```

### Observations: 

 - "Breakpoints" can be seen. Not smooth
 - Each "Piece" is considered a linear relation between Rates and Time (Year)
 
## Summery sattistics of rates:

```{r rates summary}

summary(HSC_CHSA_df$STD_RATE_PER_1000)
summary(Incidence_CHSA_df$STD_RATE_PER_1000)
summary(LifeP_CHSA_df$STD_RATE_PER_1000)

```

### Observations: (Will elaborate later)

 - None of the three rates, namely, HSC Prevalence, Age-Standardized Incidence Rate, and  Age-Standardized Life Prevalence have any negative value

# Building the Model on sample data:

## Specifics :

 - Model : Segmented regression / Joinpoint regression / Piecewise regression
 - Response (y): Age-Standardized Incidence Rate
 - Predictor : Year
 - `segmented.lm` is used
 - Filtering ALZHEIMER_DEMENTIA and 3213 Fairview CHSA
 
```{r linear regression}

sample_df <- Incidence_CHSA_df %>%
  filter(HEALTH_BOUNDARIES == "3213 Fairview" &
           DISEASE == "ALZHEIMER_DEMENTIA")

lm_model <- lm(log(STD_RATE_PER_1000)~YEAR, data = sample_df)
seg_obj<-segmented(lm_model,seg.Z=~YEAR)

```


## Model daignostics:

### Regression coefficients:

```{r}
print(summary(seg_obj))
```
#### Observations: 

 - Breakpoint is in Year 2009

### Average Annual Percent (AAPC) change:

To summarize piecewise linear relationships in segmented regression models.
```{r aapc}
print(aapc(seg_obj, wrong.se = FALSE))

```
#### Observations:

 - Positive AAPC refers to an increasing trend

## Plotting:

```{r}
plot(seg_obj, 
     conf.level=.95, 
     is=TRUE, isV=FALSE,
     col=1, shade = TRUE, 
     res=TRUE, 
     res.col=1, 
     pch=19,
     main = "Predicted Age-standardized Incidence Rates of ALZHEIMER_DEMENTIA in Fairview CHSA (2001 to 2020)",
     xlab = "Time in Years",
     ylab = "log(Age-standardized Incidence Rate")

```

#### Observations:

 - Epidemiological emphasis: Possible causes can be explored looking at the "Breakpoint" of Year 2009. 


# Fitting the Model on data frame: 

## Incidence rate:

### Model fitting:

```{r fitting incidence}

nested_incidence_df <- Incidence_CHSA_df %>%
  filter(anyTRUE==TRUE)%>%
  group_by(HEALTH_BOUNDARIES, DISEASE) %>%
  arrange(HEALTH_BOUNDARIES, DISEASE, YEAR) %>% 
  nest() %>%
  mutate(fit = map(data, ~segmented(lm(log(STD_RATE_PER_1000)~ YEAR,
               na.action= na.exclude,
               data=.), seg.Z = ~YEAR)),
         results = map(fit, augment))%>%
  unnest(results)

```

### Display of results:

```{r fitted results}

view_incidence_df <- nested_incidence_df %>%
  dplyr::select(c(`DISEASE`,
                  `HEALTH_BOUNDARIES`,
                  `YEAR`,
                  `log(STD_RATE_PER_1000)`,
                  `psi1.YEAR`,
                  `.fitted`))  
head(view_incidence_df)

```

### Saving data by diseases: 

```{r saving the plotting data}

incidence_df <- view_incidence_df %>%
  mutate(join_fitted = exp(.fitted)) %>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_fitted))

final_incidence_df <- Incidence_CHSA_df %>%
  full_join(incidence_df, by = c("DISEASE", "HEALTH_BOUNDARIES", "YEAR"))%>%
  rename(join_obs = STD_RATE_PER_1000)%>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_obs,
           join_fitted))

# Split dataframe by DISEASE
incidence_df_list <- split(final_incidence_df, list(final_incidence_df$DISEASE))

# Write out separate CSV for each DISEASE
for (DISEASE in names(incidence_df_list)) {
    write.csv(incidence_df_list[[DISEASE]], paste0(DISEASE, ".csv"))
}
```

## HSC prevalence:

### Model Fitting:

```{r}

nested_HSC_df <- HSC_CHSA_df %>%
  filter(anyTRUE==TRUE)%>%
  group_by(HEALTH_BOUNDARIES, DISEASE) %>%
  arrange(HEALTH_BOUNDARIES, DISEASE, YEAR) %>% 
  nest() %>%
  mutate(fit = map(data, ~segmented(lm(log(STD_RATE_PER_1000)~ YEAR,
               na.action= na.exclude,
               data=.), seg.Z = ~YEAR)),
         results = map(fit, augment))%>%
  unnest(results)

```

### Display of results:

```{r fitted results}

view_HSC_df <- nested_HSC_df %>%
  dplyr::select(c(`DISEASE`,
                  `HEALTH_BOUNDARIES`,
                  `YEAR`,
                  `log(STD_RATE_PER_1000)`,
                  `psi1.YEAR`,
                  `.fitted`))  
head(view_HSC_df)

```


### Saving data by diseases: 

```{r saving the plotting data}

HSC_df_list <- view_HSC_df %>%
  mutate(join_obs = exp(`log(STD_RATE_PER_1000)`)) %>%
  mutate(join_fitted = exp(.fitted)) %>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_obs,
           join_fitted))

HSC_df <- view_HSC_df %>%
  mutate(join_fitted = exp(.fitted)) %>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_fitted))

final_HSC_df <- HSC_CHSA_df %>%
  full_join(HSC_df, by = c("DISEASE", "HEALTH_BOUNDARIES", "YEAR"))%>%
  rename(join_obs = STD_RATE_PER_1000)%>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_obs,
           join_fitted))

# Split dataframe by DISEASE
HSC_df_list <- split(final_HSC_df, list(final_HSC_df$DISEASE))

# Write out separate CSV for each DISEASE
for (DISEASE in names(HSC_df_list)) {
    write.csv(HSC_df_list[[DISEASE]], paste0(DISEASE, ".csv"))
}

```


## Life Prevalence rate:

### Model Fitting:

```{r}

nested_LifeP_df <- LifeP_CHSA_df %>%
  filter(anyTRUE==TRUE)%>%
  group_by(HEALTH_BOUNDARIES, DISEASE) %>%
  arrange(HEALTH_BOUNDARIES, DISEASE, YEAR) %>% 
  nest() %>%
  mutate(fit = map(data, ~segmented(lm(log(STD_RATE_PER_1000)~ YEAR,
               na.action= na.exclude,
               data=.), seg.Z = ~YEAR)),
         results = map(fit, augment))%>%
  unnest(results)

```

### Display of results:

```{r fitted results}

view_LifeP_df <- nested_LifeP_df %>%
  dplyr::select(c(`DISEASE`,
                  `HEALTH_BOUNDARIES`,
                  `YEAR`,
                  `log(STD_RATE_PER_1000)`,
                  `psi1.YEAR`,
                  `.fitted`))  
head(view_LifeP_df)

```


### Saving data by diseases: 

```{r saving the plotting data}

LifeP_df_list <- view_LifeP_df %>%
  mutate(join_obs = exp(`log(STD_RATE_PER_1000)`)) %>%
  mutate(join_fitted = exp(.fitted)) %>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_obs,
           join_fitted))

LifeP_df <- view_LifeP_df %>%
  mutate(join_fitted = exp(.fitted)) %>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_fitted))

final_LifeP_df <- LifeP_CHSA_df %>%
  full_join(LifeP_df, by = c("DISEASE", "HEALTH_BOUNDARIES", "YEAR"))%>%
  rename(join_obs = STD_RATE_PER_1000)%>%
  dplyr::select(c(DISEASE,
           HEALTH_BOUNDARIES,
           YEAR,
           join_obs,
           join_fitted))

# Split dataframe by DISEASE
LifeP_df_list <- split(final_LifeP_df, list(final_LifeP_df$DISEASE))

# Write out separate CSV for each DISEASE
for (DISEASE in names(LifeP_df_list)) {
    write.csv(LifeP_df_list[[DISEASE]], paste0(DISEASE, ".csv"))
}

```





# References
 
 
 
 
 
 
 
 